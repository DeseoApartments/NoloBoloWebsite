<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calcolo Noleggio Biancheria</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        .add-table-btn, .remove-table-btn {
            margin: 10px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }
        .remove-table-btn {
            background-color: #f44336;
        }
        .table-controls {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <h1>Calcolo Noleggio Biancheria</h1>
    <button class="add-table-btn" onclick="addTable()">+ Aggiungi Tabella</button>
    <div id="tables-container"></div>
    <script>
        let tableIndex = 0;
        const articoli = [
            { nome: "1 Lenzuolo matrimoniale", prezzo: 7.63 },
            { nome: "1 Copripiumino matrimoniale", prezzo: 10.98 },
            { nome: "1 Lenzuolo singolo", prezzo: 6.10 },
            { nome: "1 Copripiumino singolo", prezzo: 8.54 },
            { nome: "1 Federa", prezzo: 1.53 },
            { nome: "1 Asciugamano Telo Doccia", prezzo: 3.97 },
            { nome: "1 Asciugamano Viso", prezzo: 2.75 },
            { nome: "1 Asciugamano Ospiti", prezzo: 1.53 },
            { nome: "1 Scendibagno (Tappetino)", prezzo: 3.66 },
            { nome: "1 Canovaccio", prezzo: 2.14 }
        ];

        function addTable() {
            tableIndex++;
            const container = document.getElementById('tables-container');
            const table = document.createElement('div');
            const isPrimaryTable = tableIndex === 1;
            table.innerHTML = `
                <div class="table-controls">
                    <label for="data-ordine-${tableIndex}">Data Ordine: </label>
                    <input type="date" id="data-ordine-${tableIndex}" onchange="updateDates(${tableIndex})">
                    <label for="data-ritiro-${tableIndex}">Data Ritiro: </label>
                    <input type="date" id="data-ritiro-${tableIndex}" onchange="updateDates(${tableIndex})">
                    ${isPrimaryTable ? '' : `<button class="remove-table-btn" onclick="removeTable(${tableIndex})">- Rimuovi Tabella</button>`}
                </div>
                <table id="table-${tableIndex}">
                    <thead>
                        <tr>
                            <th>Ordine ID</th>
                            <th>Cliente ID</th>
                            <th>Data Ordine</th>
                            <th>Data Ritiro</th>
                            <th>Articolo</th>
                            ${isPrimaryTable ? `
                            <th>Quantità Noleggiata</th>
                            <th>Quantità Ritirata</th>
                            <th>Quantità Non Utilizzata</th>
                            <th>Discrepanza</th>
                            <th>Prezzo Unitario (€)</th>
                            <th>Fatturare (€)</th>
                            ` : `
                            <th>Quantità Ritirata</th>
                            `}
                        </tr>
                    </thead>
                    <tbody id="table-body-${tableIndex}">
                        ${generateTableRows(tableIndex)}
                    </tbody>
                    ${isPrimaryTable ? `
                    <tfoot>
                        <tr>
                            <td colspan="10" style="text-align: right;">Totale da Fatturare (€)</td>
                            <td id="totale-fatturare-${tableIndex}">0</td>
                        </tr>
                    </tfoot>
                    ` : ''}
                </table>
            `;
            container.appendChild(table);
            updateAllCalculations();
        }

        function generateTableRows(index) {
            const isPrimaryTable = index === 1;
            return articoli.map(articolo => `
                <tr>
                    <td><input type="text" value="${index}"></td>
                    <td><input type="text" value="101"></td>
                    <td class="data-ordine"></td>
                    <td class="data-ritiro"></td>
                    <td>${articolo.nome}</td>
                    ${isPrimaryTable ? `
                    <td><input type="number" class="quantita-noleggiata" value="0" oninput="updateQuantitaNoleggiata(this)"></td>
                    <td><input type="number" class="quantita-ritirata" oninput="calcola(this)"></td>
                    <td class="quantita-non-utilizzata">0</td>
                    <td class="discrepanza">0</td>
                    <td class="prezzo-unitario">${articolo.prezzo}</td>
                    <td class="fatturare">0</td>
                    ` : `
                    <td><input type="number" class="quantita-ritirata" oninput="updateQuantitaRitirata(this, ${index})"></td>
                    `}
                </tr>
            `).join('');
        }

        function updateQuantitaNoleggiata(element) {
            const row = element.parentElement.parentElement;
            const quantitaNoleggiata = parseFloat(element.value) || 0;
            const articolo = row.cells[4].innerText;

            document.querySelectorAll('.quantita-noleggiata').forEach(input => {
                if (input.parentElement.previousElementSibling.previousElementSibling.innerText === articolo) {
                    input.value = quantitaNoleggiata;
                    calcola(input);
                }
            });
        }

        function updateQuantitaRitirata(element, tableIndex) {
            const row = element.parentElement.parentElement;
            const quantitaRitirata = parseFloat(element.value) || 0;
            const articolo = row.cells[4].innerText;

            const primaryTableRow = [...document.querySelectorAll('#table-body-1 tr')].find(tr => tr.cells[4].innerText === articolo);
            if (primaryTableRow) {
                const primaryInput = primaryTableRow.querySelector('.quantita-ritirata');
                const currentRitirataValue = parseFloat(primaryInput.value) || 0;
                const newRitirataValue = calculateTotalRitirata(articolo);
                primaryInput.value = newRitirataValue;
                calcola(primaryInput);
            }
        }

        function calculateTotalRitirata(articolo) {
            let total = 0;
            document.querySelectorAll(`.quantita-ritirata`).forEach(input => {
                const row = input.parentElement.parentElement;
                if (row.cells[4].innerText === articolo) {
                    total += parseFloat(input.value) || 0;
                }
            });
            return total;
        }

        function updateDates(index) {
            const dataOrdine = document.getElementById(`data-ordine-${index}`).value;
            const dataRitiro = document.getElementById(`data-ritiro-${index}`).value;
            document.querySelectorAll(`#table-body-${index} .data-ordine`).forEach(cell => {
                cell.innerText = dataOrdine;
            });
            document.querySelectorAll(`#table-body-${index} .data-ritiro`).forEach(cell => {
                cell.innerText = dataRitiro;
            });
        }

        function removeTable(index) {
            const table = document.querySelector(`#table-${index}`).parentElement;
            table.parentElement.removeChild(table);
            resetPrimaryTableQuantitaRitirata();
            updateAllCalculations();
        }

        function resetPrimaryTableQuantitaRitirata() {
            articoli.forEach(articolo => {
                const primaryTableRow = [...document.querySelectorAll('#table-body-1 tr')].find(tr => tr.cells[4].innerText === articolo.nome);
                if (primaryTableRow) {
                    const primaryInput = primaryTableRow.querySelector('.quantita-ritirata');
                    primaryInput.value = calculateTotalRitirata(articolo.nome);
                    calcola(primaryInput);
                }
            });
        }

        function calcola(element) {
            const row = element.parentElement.parentElement;
            const quantitaNoleggiata = parseFloat(row.querySelector('.quantita-noleggiata')?.value) || 0;
            const quantitaRitirata = parseFloat(row.querySelector('.quantita-ritirata').value) || 0;
            const prezzoUnitario = parseFloat(row.querySelector('.prezzo-unitario')?.innerText) || 0;

            if (row.querySelector('.quantita-non-utilizzata') && row.querySelector('.discrepanza')) {
                const quantitaNonUtilizzata = Math.max(quantitaNoleggiata - quantitaRitirata, 0);
                row.querySelector('.quantita-non-utilizzata').innerText = quantitaNonUtilizzata;

                const discrepanza = quantitaNoleggiata - quantitaRitirata - quantitaNonUtilizzata;
                row.querySelector('.discrepanza').innerText = discrepanza;

                const fatturare = discrepanza < 0 ? Math.abs(discrepanza) * prezzoUnitario : 0;
                row.querySelector('.fatturare').innerText = fatturare.toFixed(2);

                updateTotal();
            }
        }

        function updateTotal() {
            let totaleFatturare = 0;
            document.querySelectorAll(`#table-body-1 .fatturare`).forEach(cell => {
                totaleFatturare += parseFloat(cell.innerText) || 0;
            });
            document.getElementById(`totale-fatturare-1`).innerText = totaleFatturare.toFixed(2);
        }

        function updateAllCalculations() {
            document.querySelectorAll('#table-body-1 .quantita-ritirata').forEach(element => calcola(element));
        }

        // Aggiungi la prima tabella all'avvio
        addTable();
    </script>
</body>
</html>
